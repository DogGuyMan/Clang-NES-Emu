# iNES 파일 포맷

> 원본: https://www.nesdev.org/wiki/INES (2025-10-27 기준)

---

## 개요

**.NES 파일 포맷** (파일 확장자 `.nes`)은 NES 바이너리 프로그램 배포의 사실상 표준(de facto standard)이며, PocketNES나 Wii 버추얼 콘솔 같은 라이선스 에뮬레이터에서도 사용된다. 이 포맷은 Marat Fayzullin이 iNES라는 에뮬레이터를 위해 만들었기 때문에 흔히 **iNES 포맷**이라고 불린다. 이후 많은 한계를 해결하기 위해 NES 2.0으로 확장되었다.

---

## iNES 에뮬레이터

**iNES**는 Marat Fayzullin이 개발한 초기 NES 에뮬레이터다. NES 씬에 남긴 가장 큰 유산은 iNES ROM 파일 포맷과 매퍼 번호 체계를 대중화한 것이다.

---

## 파일 포맷 명칭

이 파일 포맷은 일반적으로 "iNES 파일 포맷" 또는 "iNES 헤더 포맷"으로 불린다. 파일 확장자가 `.nes`이므로 때때로 ".nes 파일 포맷"이라고도 하며, 이 포맷의 파일을 ".nes 파일"이라 부르기도 한다. 현재는 동일한 `.nes` 확장자를 사용하는 NES 2.0 포맷이 존재하므로, 포맷 간 차이가 중요한 맥락(사양, 포맷 지원 등)에서는 정식 포맷 이름을 사용해야 한다.

---

## iNES 파일 구조

iNES 파일은 다음 섹션들이 순서대로 구성된다:

1. **헤더** (16 바이트)
2. **트레이너**, 존재하는 경우 (0 또는 512 바이트)
3. **PRG ROM 데이터** (16384 × *x* 바이트)
4. **CHR ROM 데이터**, 존재하는 경우 (8192 × *y* 바이트)
5. **PlayChoice INST-ROM**, 존재하는 경우 (0 또는 8192 바이트)
6. **PlayChoice PROM**, 존재하는 경우 (Data 16 바이트 + CounterOut 16 바이트) — 누락된 경우가 많음

일부 ROM 이미지에는 파일 끝에 128바이트(또는 때때로 127바이트)의 타이틀이 추가로 포함된다.

---

## 헤더 포맷 (16 바이트)

| 바이트 | 설명 |
|--------|------|
| 0–3 | 상수 `$4E $45 $53 $1A` (ASCII "NES" + MS-DOS 파일 종료 문자) |
| 4 | PRG ROM 크기 — **16 KB 단위** |
| 5 | CHR ROM 크기 — **8 KB 단위** (값이 0이면 보드가 CHR RAM을 사용함) |
| 6 | Flags 6 — 매퍼, 미러링, 배터리, 트레이너 |
| 7 | Flags 7 — 매퍼, VS/Playchoice, NES 2.0 |
| 8 | Flags 8 — PRG-RAM 크기 (거의 사용되지 않는 확장) |
| 9 | Flags 9 — TV 시스템 (거의 사용되지 않는 확장) |
| 10 | Flags 10 — TV 시스템, PRG-RAM 유무 (비공식, 거의 사용되지 않는 확장) |
| 11–15 | 미사용 패딩 (0으로 채워야 하지만, 일부 덤퍼가 바이트 7–15에 자기 이름을 넣기도 함) |

---

## Flags 6

```
76543210
||||||||
|||||||+- 네임테이블 배치: 0: 수직 배치 ("수평 미러링") (CIRAM A10 = PPU A11)
|||||||                    1: 수평 배치 ("수직 미러링") (CIRAM A10 = PPU A10)
||||||+-- 1: 카트리지에 배터리 백업 PRG RAM ($6000-$7FFF) 또는 기타 영속 메모리 포함
|||||+--- 1: $7000-$71FF에 512바이트 트레이너 존재 (PRG 데이터 앞에 저장됨)
||||+---- 1: 대체 네임테이블 레이아웃
++++----- 매퍼 번호의 하위 니블 (lower nybble)
```

iNES 포맷에서 카트리지 보드는 유사한 하드웨어 및 동작을 기준으로 "매퍼(mapper)"라는 클래스로 분류되며, 각 매퍼에는 8비트 번호(NES 2.0에서는 12비트)가 부여된다. 매퍼 번호의 하위 4비트는 이 필드의 비트 7–4에 담긴다.

비트 1은 영속적 저장 메모리의 존재 여부를 나타낸다. 이는 보통 $6000에 위치한 배터리 백업 PRG-RAM 형태이지만, 매퍼별 예외가 있다:

- UNROM 512와 GTROM은 플래시 메모리를 사용하여 PRG-ROM 영역을 재기록함으로써 게임 상태를 저장한다.

### 네임테이블 배치 (Nametable Arrangement)

하드와이어드 네임테이블 레이아웃을 가진 매퍼의 경우, 수직 또는 수평 배치를 위해 CIRAM A10을 PPU A10 또는 A11에 연결하는 것을 비트 0으로 지정한다.

"대체 네임테이블 레이아웃" 비트의 정확한 의미는 매퍼에 따라 다르며, 현재 사용법과 역사적(폐기된) 사용법이 모두 존재한다.

일부 매퍼는 비트 3으로 지정되는 4-스크린 변형 보드를 가진다:

- MMC3 — *Rad Racer 2*
- Mapper 206 — *Gauntlet*

다른 매퍼들은 두 네임테이블 레이아웃 비트를 함께 사용한다:

- UNROM 512: `%....1..0`은 1-스크린 보드, `%....1..1`은 4-스크린 보드를 나타냄
- Mapper 218 (*Magic Floor*): 가능한 각 값에 대응하는 4가지 특이한 CIRAM 설정을 가짐

여러 매퍼가 유일한 옵션으로 일종의 4-스크린을 가진다. ROM에서 이를 중복 표시하기 위해 비트 3이 설정되어 있을 수 있다:

- *Napoleon Senki* (Mapper 077)
- Vs. System
- GTROM

역사적으로 여러 다른 ROM 이미지가 이 비트를 사용했다:

- Mapper 78: "대체"는 H/V, "일반"은 1scA/1scB. NES 2.0 서브매퍼가 양쪽 모두에 할당됨
- Mapper 70: "대체"는 1scA/1scB, "일반"은 하드와이어드. "대체"는 Mapper 152로 이전됨

**모호성:**

- 많은 매퍼(MMC1, MMC3, AxROM 등)는 매퍼 제어 네임테이블 미러링을 가진다. 이들은 비트 0을 무시한다.
- 4-스크린 네임테이블 RAM을 CHR-RAM과 공유하는 매퍼는 NES 2.0의 바이트 11(CHR-RAM)과 상호작용할 수 있다.
- 비트 3이 항상 4-스크린 네임테이블을 의미한다는 역사적 믿음으로 인해 많은 에뮬레이터가 이를 제대로 지원하지 못하며, 게임이 미러링 제어 레지스터에 쓰기를 시도할 때 다양한 부작용이 발생한다.

### 트레이너 (Trainer)

트레이너는 보통 다음을 위한 매퍼 레지스터 변환 및 CHR-RAM 캐싱 코드를 포함한다:

- 매퍼 ASIC를 모방할 수 없고 32 KiB CHR-RAM만 가진 초기 RAM 카트리지
- DOS용 오래된(하지만 영향력 있는) NES 에뮬레이터인 Nesticle

수정되지 않은 원본 ROM 카트리지 덤프에서는 사용되지 않는다.

---

## Flags 7

```
76543210
||||||||
|||||||+- VS Unisystem
||||||+-- PlayChoice-10 (CHR 데이터 뒤에 8 KB 힌트 스크린 데이터 저장)
||||++--- 2와 같으면 바이트 8–15가 NES 2.0 포맷
++++----- 매퍼 번호의 상위 니블 (upper nybble)
```

PlayChoice-10 비트는 공식 사양의 일부가 아니며, 대부분의 에뮬레이터는 추가 8 KB 데이터를 단순히 무시한다. PlayChoice 게임은 표준 NES PPU와 색상 강조를 다르게 처리하는 2C03 RGB PPU에서 잘 보이도록 설계되어 있다.

Vs. 게임은 코인 슬롯과 다른 팔레트를 가진다. 특정 게임이 어떤 팔레트를 사용하는지 감지하는 방법은 정의되어 있지 않다.

NES 2.0은 ROM 및 RAM 크기 등에서 더 많은 유연성을 허용하는 보다 최근의 확장이다.

---

## Flags 8

```
76543210
||||||||
++++++++- PRG RAM 크기
```

**8 KB 단위**의 PRG RAM 크기 (값 0은 호환성을 위해 8 KB로 추론됨)

이것은 iNES 포맷에 대한 후기 확장으로, 널리 사용되지 않는다. PRG RAM 크기 지정에는 NES 2.0이 권장된다.

---

## Flags 9

```
76543210
||||||||
|||||||+- TV 시스템 (0: NTSC; 1: PAL)
+++++++-- 예약됨, 0으로 설정
```

공식 사양에 포함되어 있지만, 유통 중인 ROM 이미지 중 이 비트를 사용하는 것이 거의 없어 이를 존중하는 에뮬레이터는 매우 적다.

---

## Flags 10

```
76543210
  ||  ||
  ||  ++- TV 시스템 (0: NTSC; 2: PAL; 1/3: 듀얼 호환)
  |+----- PRG RAM ($6000-$7FFF) (0: 존재; 1: 미존재)
  +------ 0: 보드에 버스 충돌 없음; 1: 보드에 버스 충돌 있음
```

이 바이트는 공식 사양의 일부가 **아니며**, 이를 존중하는 에뮬레이터는 상대적으로 적다.

바이트 8에 저장되는 PRG RAM 크기 값은 최근에 공식 사양에 추가되었으며, 그래서 유통 중인 ROM 이미지 중 이를 사용하는 것은 사실상 없다.

구 버전의 iNES 에뮬레이터는 바이트 7–15를 무시했으며, 여러 ROM 관리 도구들이 이 영역에 메시지를 기록했다. 흔히 "DiskDude!"로 채워지며, 이는 매퍼 번호에 64가 더해지는 결과를 초래한다.

**일반적인 경험 법칙**: 마지막 4바이트가 모두 0이 아니고 헤더가 NES 2.0으로 표시되지 않은 경우, 에뮬레이터는 매퍼 번호의 상위 4비트를 마스킹하거나 ROM 로드를 거부해야 한다.

---

## 변형 비교 (Variant Comparison)

.NES 파일 포맷의 헤더는 새로운 기능이 필요함에 따라 수년간 변화했다. 세 가지 구별 가능한 세대가 있다:

**Archaic iNES**
: Marat Fayzullin이 만들고 매우 오래된 버전의 iNES와 NESticle에서 사용됨. ROM 이미지 변환 및 감사 도구들이 오프셋 7–15에 서명 문자열을 저장하는 경향이 있었음.

**iNES 0.7**
: NES 카트리지 하드웨어의 다양성이 발견되었을 때 Marat Fayzullin이 만듦. 매퍼 상위 니블은 대략 2000년부터 에뮬레이터에서 지원됨.

**iNES**
: 후기 개정에서 바이트 8(PRG RAM 크기)과 바이트 9(TV 시스템)이 추가되었으나, 이 필드를 지원하는 다른 에뮬레이터는 거의 없음.

**NES 2.0**
: FPGA Kevtendo를 위해 kevtris가 만들고, 이전 헤더가 명확히 하지 못한 모호한 사례를 정리하기 위해 NESdev 커뮤니티가 유지 관리. 2010년대부터 널리 채택됨.

| 항목 | Archaic iNES | iNES | NES 2.0 |
|------|-------------|------|---------|
| 바이트 7 | 미사용 | 매퍼 상위 니블, Vs. | 매퍼 상위 니블, NES 2.0 시그니처, PlayChoice, Vs. |
| 바이트 8 | 미사용 | 전체 PRG RAM 크기 (선형) | 매퍼 최상위 니블, 매퍼 변형 |
| 바이트 9 | 미사용 | TV 시스템 | ROM 크기 상위 비트 |
| 바이트 10 | 미사용 | 미사용 | PRG RAM 크기 (로그; 배터리/비배터리) |
| 바이트 11 | 미사용 | 미사용 | VRAM 크기 (로그; 배터리/비배터리) |
| 바이트 12 | 미사용 | 미사용 | TV 시스템 |
| 바이트 13 | 미사용 | 미사용 | Vs. PPU 변형 |
| 바이트 14 | 미사용 | 미사용 | 기타 ROM |
| 바이트 15 | 미사용 | 미사용 | 기본 확장 장치 |
| 지원 매퍼 | 0–15 | 0–255 | 0–4095 |

### 권장 감지 절차

1. 바이트 7 AND `$0C` = `$08`이고, 바이트 9를 고려한 크기가 실제 ROM 이미지 크기를 초과하지 않으면 → **NES 2.0**
2. 바이트 7 AND `$0C` = `$04`이면 → **Archaic iNES**
3. 바이트 7 AND `$0C` = `$00`이고, 바이트 12–15가 모두 0이면 → **iNES**
4. 그 외 → **iNES 0.7 또는 Archaic iNES**

---

## 참고 자료

- [공식 iNES 파일 포맷 사양](http://fms.komkon.org/EMUL8/NES.html#LABM)
- [iNES 포맷 (rvu)](http://nesdev.org/iNES.txt)
- [iNES 헤더/포맷 (VmprHntrD)](http://nesdev.org/neshdr20.txt)
- [iNES 에뮬레이터](http://fms.komkon.org/iNES/)
- [INES 1.0 매퍼 그리드](https://www.nesdev.org/wiki/Mapper)
- [INES 매퍼 목록](https://www.nesdev.org/wiki/List_of_mappers)
- [NES 2.0 포맷](https://www.nesdev.org/wiki/NES_2.0)
